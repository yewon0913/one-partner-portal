<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ONE PARTNER ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</title>
  <link rel="icon" href="logo.png" type="image/png">
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable-dynamic-subset.min.css" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Pretendard Variable', 'Pretendard', -apple-system, sans-serif;
      background: #0A1628; color: #FFFFFF; min-height: 100vh;
    }

    /* Login */
    .login-screen {
      display: flex; align-items: center; justify-content: center;
      min-height: 100vh; padding: 20px;
    }
    .login-card {
      background: #132240; border-radius: 20px;
      padding: 40px 32px; width: 100%; max-width: 400px;
      border: 1px solid #1E3A5F; text-align: center;
    }
    .login-logo { width: 80px; height: 80px; border-radius: 16px; margin-bottom: 16px; }
    .login-title { font-size: 22px; font-weight: 800; margin-bottom: 8px; }
    .login-subtitle { font-size: 14px; color: #8A9BB5; margin-bottom: 28px; }
    .login-input {
      width: 100%; background: #0D1E38; border-radius: 12px; padding: 16px 18px;
      border: 1.5px solid #1E3A5F; color: #FFFFFF; font-size: 16px;
      font-family: inherit; outline: none; margin-bottom: 14px;
    }
    .login-input:focus { border-color: #C9A84C; }
    .login-input::placeholder { color: #5A6B80; }
    .login-btn {
      width: 100%; padding: 16px; border: none; border-radius: 12px;
      background: linear-gradient(135deg, #A8893D, #C9A84C, #E8D48B);
      color: #0A1628; font-size: 17px; font-weight: 800;
      cursor: pointer; font-family: inherit; margin-top: 4px;
    }
    .login-btn:active { transform: scale(0.98); }
    .login-error { color: #F87171; font-size: 14px; margin-top: 12px; display: none; }

    /* Dashboard */
    .dashboard { display: none; }
    .dashboard.visible { display: block; }

    .dash-header {
      background: #132240; border-bottom: 1px solid #1E3A5F;
      padding: 16px 24px; display: flex; align-items: center; justify-content: space-between;
    }
    .dash-header-left { display: flex; align-items: center; gap: 12px; }
    .dash-logo { width: 40px; height: 40px; border-radius: 8px; }
    .dash-title { font-size: 18px; font-weight: 800; }
    .dash-subtitle { font-size: 12px; color: #8A9BB5; }
    .header-actions { display: flex; gap: 10px; align-items: center; }
    .logout-btn {
      background: none; border: 1px solid #1E3A5F; color: #8A9BB5;
      padding: 8px 16px; border-radius: 8px; font-size: 13px;
      cursor: pointer; font-family: inherit;
    }
    .logout-btn:hover { border-color: #C9A84C; color: #C9A84C; }

    /* Tab Navigation */
    .tab-nav {
      display: flex; background: #0D1E38; border-bottom: 1px solid #1E3A5F;
      padding: 0 24px; overflow-x: auto;
    }
    .tab-btn {
      padding: 16px 24px; background: none; border: none; border-bottom: 3px solid transparent;
      color: #8A9BB5; font-size: 15px; font-weight: 700; cursor: pointer;
      font-family: inherit; white-space: nowrap; transition: all 0.2s;
    }
    .tab-btn:hover { color: #C9A84C; }
    .tab-btn.active { color: #C9A84C; border-bottom-color: #C9A84C; }
    .tab-badge {
      display: inline-block; background: #C9A84C; color: #0A1628;
      font-size: 11px; font-weight: 800; padding: 2px 7px;
      border-radius: 10px; margin-left: 6px; vertical-align: middle;
    }

    /* Tab Content */
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Stats */
    .stats-bar { display: flex; gap: 16px; padding: 20px 24px; overflow-x: auto; }
    .stat-card {
      background: #132240; border-radius: 14px; padding: 20px;
      border: 1px solid #1E3A5F; min-width: 160px; flex: 1;
    }
    .stat-label { font-size: 13px; color: #8A9BB5; margin-bottom: 6px; }
    .stat-value { font-size: 28px; font-weight: 800; color: #C9A84C; }

    /* Toolbar */
    .toolbar {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 24px; gap: 12px; flex-wrap: wrap;
    }
    .toolbar-title { font-size: 18px; font-weight: 700; }
    .toolbar-actions { display: flex; gap: 10px; }
    .export-btn {
      padding: 10px 20px; border-radius: 10px; border: 1.5px solid #C9A84C;
      background: transparent; color: #C9A84C; font-size: 14px; font-weight: 600;
      cursor: pointer; font-family: inherit; display: flex; align-items: center; gap: 6px;
    }
    .export-btn:hover { background: rgba(201,168,76,0.08); }
    .refresh-btn {
      padding: 10px 16px; border-radius: 10px; border: 1px solid #1E3A5F;
      background: #132240; color: #8A9BB5; font-size: 14px;
      cursor: pointer; font-family: inherit;
    }
    .refresh-btn:hover { border-color: #C9A84C; color: #C9A84C; }

    /* Table */
    .table-wrap { padding: 0 24px 40px; overflow-x: auto; }
    table {
      width: 100%; border-collapse: collapse; background: #132240;
      border-radius: 14px; overflow: hidden; min-width: 900px;
    }
    thead { background: #0D1E38; }
    th {
      padding: 14px 16px; text-align: left; font-size: 13px; font-weight: 700;
      color: #C9A84C; white-space: nowrap; border-bottom: 1px solid #1E3A5F;
    }
    td {
      padding: 14px 16px; font-size: 13px; color: #FFFFFF;
      border-bottom: 0.5px solid #1E3A5F; white-space: nowrap;
    }
    tr:hover td { background: rgba(201,168,76,0.04); }
    .badge { padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; }
    .badge-yes { background: rgba(239,68,68,0.15); color: #F87171; }
    .badge-no { background: rgba(34,197,94,0.15); color: #4ADE80; }
    .badge-lead { background: rgba(59,130,246,0.15); color: #60A5FA; }

    .empty-state { text-align: center; padding: 60px 20px; color: #8A9BB5; }
    .empty-icon { font-size: 48px; margin-bottom: 16px; }
    .empty-text { font-size: 16px; font-weight: 600; }
    .empty-sub { font-size: 14px; margin-top: 8px; }

    /* Modal */
    .modal-overlay {
      display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7); z-index: 100;
      align-items: center; justify-content: center; padding: 20px;
    }
    .modal-overlay.visible { display: flex; }
    .modal {
      background: #132240; border-radius: 20px; padding: 32px;
      max-width: 500px; width: 100%; border: 1px solid #1E3A5F;
      max-height: 80vh; overflow-y: auto;
    }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .modal-title { font-size: 20px; font-weight: 800; }
    .modal-close { background: none; border: none; color: #8A9BB5; font-size: 24px; cursor: pointer; }
    .detail-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 0.5px solid #1E3A5F; }
    .detail-row:last-child { border-bottom: none; }
    .detail-label { color: #8A9BB5; font-size: 14px; }
    .detail-value { color: #FFFFFF; font-size: 14px; font-weight: 600; text-align: right; max-width: 60%; word-break: break-all; }
    .delete-btn {
      width: 100%; padding: 14px; border: none; border-radius: 12px;
      background: rgba(239,68,68,0.15); color: #F87171;
      font-size: 15px; font-weight: 700; cursor: pointer;
      margin-top: 20px; font-family: inherit;
    }
    .delete-btn:hover { background: rgba(239,68,68,0.25); }

    /* Telegram Settings */
    .settings-section {
      padding: 24px; max-width: 600px;
    }
    .settings-card {
      background: #132240; border-radius: 16px; padding: 28px;
      border: 1px solid #1E3A5F; margin-bottom: 20px;
    }
    .settings-title { font-size: 18px; font-weight: 800; margin-bottom: 8px; }
    .settings-desc { font-size: 14px; color: #8A9BB5; margin-bottom: 20px; line-height: 1.6; }
    .settings-label { font-size: 14px; color: #8A9BB5; font-weight: 600; margin-bottom: 8px; margin-top: 16px; }
    .settings-input {
      width: 100%; background: #0D1E38; border-radius: 10px; padding: 14px 16px;
      border: 1.5px solid #1E3A5F; color: #FFFFFF; font-size: 15px;
      font-family: inherit; outline: none;
    }
    .settings-input:focus { border-color: #C9A84C; }
    .settings-input::placeholder { color: #5A6B80; }
    .settings-btn {
      padding: 14px 28px; border: none; border-radius: 12px;
      background: linear-gradient(135deg, #A8893D, #C9A84C, #E8D48B);
      color: #0A1628; font-size: 15px; font-weight: 800;
      cursor: pointer; font-family: inherit; margin-top: 20px; margin-right: 10px;
    }
    .settings-btn:active { transform: scale(0.98); }
    .settings-btn.outline {
      background: transparent; border: 1.5px solid #C9A84C; color: #C9A84C;
    }
    .status-dot {
      display: inline-block; width: 10px; height: 10px; border-radius: 50%;
      margin-right: 6px; vertical-align: middle;
    }
    .status-on { background: #4ADE80; }
    .status-off { background: #F87171; }
    .status-text { font-size: 14px; font-weight: 600; vertical-align: middle; }

    .guide-steps { margin-top: 16px; }
    .guide-step {
      display: flex; gap: 12px; padding: 10px 0;
      border-bottom: 0.5px solid #1E3A5F; font-size: 14px; color: #8A9BB5; line-height: 1.5;
    }
    .guide-step:last-child { border-bottom: none; }
    .guide-num {
      background: #C9A84C; color: #0A1628; width: 24px; height: 24px;
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      font-size: 12px; font-weight: 800; flex-shrink: 0;
    }
  </style>
</head>
<body>
  <!-- Login -->
  <div class="login-screen" id="loginScreen">
    <div class="login-card">
      <img src="logo.png" alt="ONE PARTNER" class="login-logo">
      <div class="login-title">ê´€ë¦¬ì ë¡œê·¸ì¸</div>
      <div class="login-subtitle">ONE PARTNER í†µí•© ê´€ë¦¬ ì‹œìŠ¤í…œ</div>
      <input type="password" class="login-input" id="adminPw" placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" onkeypress="if(event.key==='Enter')doLogin()">
      <button class="login-btn" onclick="doLogin()">ë¡œê·¸ì¸</button>
      <div class="login-error" id="loginError">ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
    </div>
  </div>

  <!-- Dashboard -->
  <div class="dashboard" id="dashboard">
    <div class="dash-header">
      <div class="dash-header-left">
        <img src="logo.png" alt="" class="dash-logo">
        <div>
          <div class="dash-title">ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</div>
          <div class="dash-subtitle">ONE PARTNER í†µí•© ê´€ë¦¬</div>
        </div>
      </div>
      <div class="header-actions">
        <button class="logout-btn" onclick="doLogout()">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-nav">
      <button class="tab-btn active" onclick="switchTab('leads')" id="tabLeads">
        1ì°¨ ë¦¬ë“œ ì‹ ì²­ <span class="tab-badge" id="leadBadge">0</span>
      </button>
      <button class="tab-btn" onclick="switchTab('diagnosis')" id="tabDiagnosis">
        2ì°¨ ì •ë°€ ì§„ë‹¨ <span class="tab-badge" id="diagBadge">0</span>
      </button>
      <button class="tab-btn" onclick="switchTab('telegram')" id="tabTelegram">
        ì•Œë¦¼ ì„¤ì •
      </button>
    </div>

    <!-- Tab 1: Leads -->
    <div class="tab-content active" id="contentLeads">
      <div class="stats-bar">
        <div class="stat-card">
          <div class="stat-label">ì´ ë¦¬ë“œ ìˆ˜</div>
          <div class="stat-value" id="leadTotal">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">ì˜¤ëŠ˜ ì ‘ìˆ˜</div>
          <div class="stat-value" id="leadToday">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">ì´ë²ˆ ì£¼</div>
          <div class="stat-value" id="leadWeek">0</div>
        </div>
      </div>
      <div class="toolbar">
        <div class="toolbar-title">ë¦¬ë“œ ì‹ ì²­ ëª©ë¡</div>
        <div class="toolbar-actions">
          <button class="refresh-btn" onclick="loadAllData()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
          <button class="export-btn" onclick="exportLeads()">ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
        </div>
      </div>
      <div class="table-wrap"><div id="leadTable"></div></div>
    </div>

    <!-- Tab 2: Diagnosis -->
    <div class="tab-content" id="contentDiagnosis">
      <div class="stats-bar">
        <div class="stat-card">
          <div class="stat-label">ì´ ì ‘ìˆ˜ ê±´ìˆ˜</div>
          <div class="stat-value" id="diagTotal">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">ì˜¤ëŠ˜ ì ‘ìˆ˜</div>
          <div class="stat-value" id="diagToday">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">ì´ë²ˆ ì£¼</div>
          <div class="stat-value" id="diagWeek">0</div>
        </div>
      </div>
      <div class="toolbar">
        <div class="toolbar-title">ì •ë°€ ì§„ë‹¨ ì ‘ìˆ˜ ëª©ë¡</div>
        <div class="toolbar-actions">
          <button class="refresh-btn" onclick="loadAllData()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
          <button class="export-btn" onclick="exportDiagnosis()">ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
        </div>
      </div>
      <div class="table-wrap"><div id="diagTable"></div></div>
    </div>

    <!-- Tab 3: Telegram Settings -->
    <div class="tab-content" id="contentTelegram">
      <div class="settings-section">
        <div class="settings-card">
          <div class="settings-title">í…”ë ˆê·¸ë¨ ì•Œë¦¼ ì„¤ì •</div>
          <div class="settings-desc">
            ìƒˆë¡œìš´ ë¦¬ë“œ ì‹ ì²­ ë˜ëŠ” ì •ë°€ ì§„ë‹¨ ì„œë¥˜ê°€ ì ‘ìˆ˜ë˜ë©´ í…”ë ˆê·¸ë¨ìœ¼ë¡œ ì¦‰ì‹œ ì•Œë¦¼ì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          </div>
          <div style="margin-bottom:20px">
            <span class="status-dot" id="telegramStatusDot"></span>
            <span class="status-text" id="telegramStatusText"></span>
          </div>

          <div class="settings-card" style="background:#0D1E38;border-color:#1E3A5F;padding:20px">
            <div style="font-size:15px;font-weight:700;margin-bottom:12px;color:#C9A84C">ì„¤ì • ê°€ì´ë“œ</div>
            <div class="guide-steps">
              <div class="guide-step">
                <span class="guide-num">1</span>
                <span>í…”ë ˆê·¸ë¨ì—ì„œ <b style="color:#fff">@BotFather</b>ë¥¼ ê²€ìƒ‰í•˜ì—¬ ëŒ€í™”ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.</span>
              </div>
              <div class="guide-step">
                <span class="guide-num">2</span>
                <span><b style="color:#fff">/newbot</b> ëª…ë ¹ì–´ë¡œ ìƒˆ ë´‡ì„ ìƒì„±í•˜ê³  Bot Tokenì„ ë³µì‚¬í•©ë‹ˆë‹¤.</span>
              </div>
              <div class="guide-step">
                <span class="guide-num">3</span>
                <span>ìƒì„±ëœ ë´‡ì—ê²Œ ì•„ë¬´ ë©”ì‹œì§€ë¥¼ ë³´ë‚¸ í›„, ë¸Œë¼ìš°ì €ì—ì„œ <b style="color:#fff">https://api.telegram.org/bot{í† í°}/getUpdates</b> ì— ì ‘ì†í•˜ì—¬ Chat IDë¥¼ í™•ì¸í•©ë‹ˆë‹¤.</span>
              </div>
              <div class="guide-step">
                <span class="guide-num">4</span>
                <span>ì•„ë˜ì— Bot Tokenê³¼ Chat IDë¥¼ ì…ë ¥í•˜ê³  ì €ì¥í•©ë‹ˆë‹¤.</span>
              </div>
            </div>
          </div>

          <div class="settings-label">Bot Token</div>
          <input type="text" class="settings-input" id="botToken" placeholder="ì˜ˆ: 123456789:ABCdefGHIjklMNOpqrsTUVwxyz">

          <div class="settings-label">Chat ID</div>
          <input type="text" class="settings-input" id="chatId" placeholder="ì˜ˆ: 987654321">

          <div style="margin-top:24px">
            <button class="settings-btn" onclick="saveTelegramConfig()">ì €ì¥</button>
            <button class="settings-btn outline" onclick="testTelegram()">í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ë³´ë‚´ê¸°</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Detail Modal -->
  <div class="modal-overlay" id="detailModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">ìƒì„¸ ì •ë³´</div>
        <button class="modal-close" onclick="closeModal()">âœ•</button>
      </div>
      <div id="detailContent"></div>
      <button class="delete-btn" id="deleteBtn">ì´ ê±´ ì‚­ì œ</button>
    </div>
  </div>

  <script>
    const ADMIN_PW = 'onepartner2026';
    let leadsData = [];
    let diagData = [];

    // Auth
    function doLogin() {
      if (document.getElementById('adminPw').value === ADMIN_PW) {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('dashboard').classList.add('visible');
        sessionStorage.setItem('op_admin', 'true');
        loadAllData();
        loadTelegramStatus();
      } else {
        document.getElementById('loginError').style.display = 'block';
      }
    }
    function doLogout() {
      sessionStorage.removeItem('op_admin');
      document.getElementById('dashboard').classList.remove('visible');
      document.getElementById('loginScreen').style.display = 'flex';
      document.getElementById('adminPw').value = '';
      document.getElementById('loginError').style.display = 'none';
    }
    if (sessionStorage.getItem('op_admin') === 'true') {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('dashboard').classList.add('visible');
      loadAllData();
      loadTelegramStatus();
    }

    // Tabs
    function switchTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      if (tab === 'leads') {
        document.getElementById('tabLeads').classList.add('active');
        document.getElementById('contentLeads').classList.add('active');
      } else if (tab === 'diagnosis') {
        document.getElementById('tabDiagnosis').classList.add('active');
        document.getElementById('contentDiagnosis').classList.add('active');
      } else {
        document.getElementById('tabTelegram').classList.add('active');
        document.getElementById('contentTelegram').classList.add('active');
      }
    }

    // Load data
    function loadAllData() {
      fetch('/api/leads').then(r => r.json()).then(data => {
        leadsData = data;
        renderLeads(data);
      }).catch(() => renderLeads([]));

      fetch('/api/submissions').then(r => r.json()).then(data => {
        diagData = data;
        renderDiagnosis(data);
      }).catch(() => renderDiagnosis([]));
    }

    function countStats(data) {
      const total = data.length;
      const today = new Date().toLocaleDateString('ko-KR');
      const todayCount = data.filter(s => {
        try { return new Date(s.submittedAt).toLocaleDateString('ko-KR') === today; } catch { return false; }
      }).length;
      const weekAgo = new Date(); weekAgo.setDate(weekAgo.getDate() - 7);
      const weekCount = data.filter(s => {
        try { return new Date(s.submittedAt) >= weekAgo; } catch { return false; }
      }).length;
      return { total, todayCount, weekCount };
    }

    // Render Leads
    function renderLeads(data) {
      const stats = countStats(data);
      document.getElementById('leadTotal').textContent = stats.total;
      document.getElementById('leadToday').textContent = stats.todayCount;
      document.getElementById('leadWeek').textContent = stats.weekCount;
      document.getElementById('leadBadge').textContent = stats.total;

      const container = document.getElementById('leadTable');
      if (stats.total === 0) {
        container.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ“‹</div><div class="empty-text">ì•„ì§ ì ‘ìˆ˜ëœ ë¦¬ë“œê°€ ì—†ìŠµë‹ˆë‹¤.</div><div class="empty-sub">ê³ ê°ì´ ì§„ë‹¨ì„ ì‹ ì²­í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div></div>`;
        return;
      }
      const sorted = [...data].reverse();
      container.innerHTML = `<table><thead><tr>
        <th>No.</th><th>ì ‘ìˆ˜ì¼ì‹œ</th><th>ì—…ì¢…</th><th>ì§€ì—­</th><th>ì—…ì²´ëª…</th><th>í¬ë§ìê¸ˆ</th><th>ì„±í•¨</th><th>ì—°ë½ì²˜</th><th>í†µí™”ì‹œê°„</th><th>ìƒì„¸</th>
      </tr></thead><tbody>
        ${sorted.map((s, i) => `<tr>
          <td>${stats.total - i}</td>
          <td>${s.submittedAt || '-'}</td>
          <td>${s.industry || '-'}</td>
          <td>${s.region || '-'}</td>
          <td>${s.companyName || '-'}</td>
          <td>${s.fundingAmount || '-'}</td>
          <td>${s.contactName || '-'}</td>
          <td>${s.contactPhone || '-'}</td>
          <td>${s.preferredTime || '-'}</td>
          <td><button class="refresh-btn" style="padding:6px 12px;font-size:12px" onclick='showLeadDetail(${JSON.stringify(s).replace(/'/g,"&#39;")})'>ë³´ê¸°</button></td>
        </tr>`).join('')}
      </tbody></table>`;
    }

    // Render Diagnosis
    function renderDiagnosis(data) {
      const stats = countStats(data);
      document.getElementById('diagTotal').textContent = stats.total;
      document.getElementById('diagToday').textContent = stats.todayCount;
      document.getElementById('diagWeek').textContent = stats.weekCount;
      document.getElementById('diagBadge').textContent = stats.total;

      const container = document.getElementById('diagTable');
      if (stats.total === 0) {
        container.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ“‹</div><div class="empty-text">ì•„ì§ ì ‘ìˆ˜ëœ ì„œë¥˜ê°€ ì—†ìŠµë‹ˆë‹¤.</div><div class="empty-sub">ê³ ê°ì´ ì„œë¥˜ë¥¼ ì œì¶œí•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div></div>`;
        return;
      }
      const sorted = [...data].reverse();
      container.innerHTML = `<table style="min-width:1200px"><thead><tr>
        <th>No.</th><th>ì ‘ìˆ˜ì¼ì‹œ</th><th>ì‚¬ì—…ìë“±ë¡ì¦</th><th>ì§ì›ìˆ˜</th><th>23ë§¤ì¶œ</th><th>24ë§¤ì¶œ</th><th>25ë§¤ì¶œ</th><th>ì‹ ìš©ì ìˆ˜</th><th>ì—°ì²´</th><th>ì •ë¶€ëŒ€ì¶œ</th><th>ê¸°íƒ€ëŒ€ì¶œ</th><th>ìƒì„¸</th>
      </tr></thead><tbody>
        ${sorted.map((s, i) => `<tr>
          <td>${stats.total - i}</td>
          <td>${s.submittedAt || '-'}</td>
          <td>${s.bizFileName || '-'}</td>
          <td>${s.employeeCount || '-'}ëª…</td>
          <td>${s.revenue2023 || '-'} ë§Œì›</td>
          <td>${s.revenue2024 || '-'} ë§Œì›</td>
          <td>${s.revenue2025 || '-'} ë§Œì›</td>
          <td>${s.creditScore || '-'}ì </td>
          <td><span class="badge ${s.overdue === 'ìˆìŒ' ? 'badge-yes' : 'badge-no'}">${s.overdue || '-'}</span></td>
          <td><span class="badge ${s.govLoan === 'ìˆìŒ' ? 'badge-yes' : 'badge-no'}">${s.govLoan || '-'}</span></td>
          <td>${s.otherLoans || '-'}</td>
          <td><button class="refresh-btn" style="padding:6px 12px;font-size:12px" onclick='showDiagDetail(${JSON.stringify(s).replace(/'/g,"&#39;")})'>ë³´ê¸°</button></td>
        </tr>`).join('')}
      </tbody></table>`;
    }

    // Detail Modals
    function showLeadDetail(s) {
      document.getElementById('modalTitle').textContent = 'ë¦¬ë“œ ìƒì„¸ ì •ë³´';
      const rows = [
        ['ì ‘ìˆ˜ì¼ì‹œ', s.submittedAt], ['ì—…ì¢…', s.industry], ['ì§€ì—­', s.region],
        ['ì—…ì²´ëª…', s.companyName], ['í¬ë§ ìê¸ˆ', s.fundingAmount],
        ['ì„±í•¨', s.contactName], ['ì—°ë½ì²˜', s.contactPhone], ['í†µí™” ê°€ëŠ¥ ì‹œê°„', s.preferredTime]
      ];
      document.getElementById('detailContent').innerHTML = rows.map(([l,v]) =>
        `<div class="detail-row"><span class="detail-label">${l}</span><span class="detail-value">${v || '-'}</span></div>`
      ).join('');
      document.getElementById('deleteBtn').onclick = () => {
        if (confirm('ì´ ë¦¬ë“œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          fetch('/api/leads/' + s.id, { method: 'DELETE' }).then(() => { closeModal(); loadAllData(); });
        }
      };
      document.getElementById('detailModal').classList.add('visible');
    }

    function showDiagDetail(s) {
      document.getElementById('modalTitle').textContent = 'ì •ë°€ ì§„ë‹¨ ìƒì„¸ ì •ë³´';
      const rows = [
        ['ì ‘ìˆ˜ì¼ì‹œ', s.submittedAt], ['ì‚¬ì—…ìë“±ë¡ì¦', s.bizFileName],
        ['ì§ì› ìˆ˜', (s.employeeCount || '-') + 'ëª…'],
        ['2023 ë§¤ì¶œ', (s.revenue2023 || '-') + ' ë§Œì›'],
        ['2024 ë§¤ì¶œ', (s.revenue2024 || '-') + ' ë§Œì›'],
        ['2025 ë§¤ì¶œ(ì˜ˆìƒ)', (s.revenue2025 || '-') + ' ë§Œì›'],
        ['ì‹ ìš© ì ìˆ˜', (s.creditScore || '-') + 'ì '],
        ['ì‹ ìš©ì ìˆ˜ ìº¡ì²˜', s.creditFileName || '-'],
        ['ì—°ì²´ ì—¬ë¶€', s.overdue], ['ì •ë¶€ ëŒ€ì¶œ', s.govLoan],
      ];
      if (s.govLoans && s.govLoans.length > 0) {
        s.govLoans.forEach((l, i) => {
          rows.push([`ëŒ€ì¶œ${i+1}: ${l.institution}`, `${l.date} / ${l.amount}ë§Œì›`]);
        });
      }
      rows.push(['ê¸°íƒ€ ëŒ€ì¶œ', s.otherLoans]);

      document.getElementById('detailContent').innerHTML = rows.map(([l,v]) =>
        `<div class="detail-row"><span class="detail-label">${l}</span><span class="detail-value">${v || '-'}</span></div>`
      ).join('');
      document.getElementById('deleteBtn').onclick = () => {
        if (confirm('ì´ ì ‘ìˆ˜ ê±´ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          fetch('/api/submissions/' + s.id, { method: 'DELETE' }).then(() => { closeModal(); loadAllData(); });
        }
      };
      document.getElementById('detailModal').classList.add('visible');
    }

    function closeModal() { document.getElementById('detailModal').classList.remove('visible'); }

    // Telegram
    function loadTelegramStatus() {
      fetch('/api/telegram-config').then(r => r.json()).then(data => {
        const dot = document.getElementById('telegramStatusDot');
        const text = document.getElementById('telegramStatusText');
        if (data.hasToken && data.hasChatId) {
          dot.className = 'status-dot status-on';
          text.textContent = 'ì•Œë¦¼ í™œì„±í™”ë¨';
          text.style.color = '#4ADE80';
        } else {
          dot.className = 'status-dot status-off';
          text.textContent = 'ì•Œë¦¼ ë¯¸ì„¤ì •';
          text.style.color = '#F87171';
        }
      });
    }

    function saveTelegramConfig() {
      const botToken = document.getElementById('botToken').value.trim();
      const chatId = document.getElementById('chatId').value.trim();
      if (!botToken || !chatId) { alert('Bot Tokenê³¼ Chat IDë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
      fetch('/api/telegram-config', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ botToken, chatId })
      }).then(r => r.json()).then(() => {
        alert('í…”ë ˆê·¸ë¨ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
        loadTelegramStatus();
      });
    }

    function testTelegram() {
      fetch('/api/telegram-test', { method: 'POST' }).then(r => r.json()).then(() => {
        alert('í…ŒìŠ¤íŠ¸ ì•Œë¦¼ì„ ì „ì†¡í–ˆìŠµë‹ˆë‹¤. í…”ë ˆê·¸ë¨ì„ í™•ì¸í•´ì£¼ì„¸ìš”!');
      });
    }

    // Export
    function exportLeads() {
      if (leadsData.length === 0) { alert('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
      let csv = '\uFEFF';
      csv += ['No','ì ‘ìˆ˜ì¼ì‹œ','ì—…ì¢…','ì§€ì—­','ì—…ì²´ëª…','í¬ë§ìê¸ˆ','ì„±í•¨','ì—°ë½ì²˜','í†µí™”ì‹œê°„'].join(',') + '\n';
      leadsData.forEach((s, i) => {
        csv += [i+1, `"${s.submittedAt||''}"`, `"${s.industry||''}"`, `"${s.region||''}"`,
          `"${s.companyName||''}"`, `"${s.fundingAmount||''}"`, `"${s.contactName||''}"`,
          `"${s.contactPhone||''}"`, `"${s.preferredTime||''}"`].join(',') + '\n';
      });
      downloadCSV(csv, 'ONE_PARTNER_ë¦¬ë“œì‹ ì²­');
    }

    function exportDiagnosis() {
      if (diagData.length === 0) { alert('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
      let csv = '\uFEFF';
      csv += ['No','ì ‘ìˆ˜ì¼ì‹œ','ì‚¬ì—…ìë“±ë¡ì¦','ì§ì›ìˆ˜','23ë§¤ì¶œ(ë§Œì›)','24ë§¤ì¶œ(ë§Œì›)','25ë§¤ì¶œ(ë§Œì›)','ì‹ ìš©ì ìˆ˜','ì—°ì²´ì—¬ë¶€','ì •ë¶€ëŒ€ì¶œ','ê¸°íƒ€ëŒ€ì¶œ'].join(',') + '\n';
      diagData.forEach((s, i) => {
        csv += [i+1, `"${s.submittedAt||''}"`, `"${s.bizFileName||''}"`, s.employeeCount||'',
          `"${s.revenue2023||''}"`, `"${s.revenue2024||''}"`, `"${s.revenue2025||''}"`,
          s.creditScore||'', s.overdue||'', s.govLoan||'', `"${s.otherLoans||''}"`].join(',') + '\n';
      });
      downloadCSV(csv, 'ONE_PARTNER_ì •ë°€ì§„ë‹¨');
    }

    function downloadCSV(csv, prefix) {
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${prefix}_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
